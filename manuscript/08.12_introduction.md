## 12 Введение

### 12.1 Symfony and security

Димтрибутив Symfony Standard Edition поставляется вместе с компонентом Security, бандлом SecurityBundle и (до версии 
 2.3) бандлом SecurityExtraBundle (@dbykadorov: фактически это был `jms/security-extra-bundle`, который, начиная
с версии 2.3, не входит в стандартный дистрибутив и должен устанавливаться отдельно). Настраивая конфигурацию вашего
приложения (используя security.yml), вы совершенно бесплатно (-: получаете следующие возможности:

- Одна или несколько областей, защищённых формой логина или HTTP-аутентификацией.
- Полную свободу в вопросе получения пользовательских данных (@dbykadorov: вероятно имеется в виду свобода 
выбора - откуда загружать пользовательские данные).
- Несколько способов хэширования пользовательских паролей.
- Способ для организации выхода.
- События, связанные с обеспечением безопасности, которые доставлюятся через диспетчер событий приложения.
- Авторизация пользователей, на основании их ролей.
- Настраиваемые обработчики хранения сессий (например, вы можете определить, где должны храниться данные сессий).
- Механизм списков котроля доступа (ACL), который вы можете использовать для выделения особых прав 
(таких как "редактирование", "просмотр", "удаление" и т.д.) для конкретных пользователей в отношении конкретных
объектов.

Все функции, перечисленные выше, отлично реализованы, но объединение в них множества различных концепций
(таких как : firewall, authentication listener, authentication provider, exception handler, entry point, ACL, 
ACE, security identity, object identity, etc.) может вызвать определённые затруднения при их использовании.
Вот почему, если вы создаёте какое-либо приложение, в котором аутентифицированные пользователи отличаются от гостей
или имеются ограничения по доступу на уровне объектов, вы должны взять себя в руки и прочитать об
обеспечении безопасности в Symfony.

Вот несколько отличных ресурсов, с которых вы могли бы начать:

- Раздел [Безопасность](http://symfony.com/doc/current/security.html) на сайте symfony.com, который
даст вам основные представления по управлению аутентификацией и авторизацией в Symfony-приложении.
- Документация о [компоненте Security](http://symfony.com/doc/current/components/security.html) 
(@dbykadorov: основа которой была также написана Маттиасом, автором этой книги), более детально описывающая
все части компонента, которые так или иначе играют роль в обеспечении безопасности вашего приложения.

Хорошая новость для вас - там есть что почитать! После прочтения документации вам нужно будет сравнить
список возможностей Symfony с вашим собственным (или вашего приложения) списком потребностей, потому что
плохая новость заключается в том, что многие вопросы там не рассматриваются.

Вот примеры функций и/или ситуаций, которые вам нужно будет создать и/или проверить самостоятельно:

- Очитска входных данных (для этого практически ничего не делается автоматически, так что этому вопросу будет выеделен отдельный подраздел ниже).
- Автоматическая (интерактиваня/по времени) инвалидация сессии.
- Мониторинг/предотвращение угона сессий.
- Предотвращение брутфорс-атак (простой подбор логинов-паролей) на формы логина.
- Хранение/управление типами пользователей, их ролями и группами ролей динамически.
- Отображение красивых страниц "у вас недостаточно прав для...".
- Создание паролей, устойчивых к взлому.
- Предотвращение кэширования секретных данных браузерами.

Для того, чтобы реально понимать, что необходимо предпринять, и какие решения будут лучшими,
чтобы обломать зубы "плохим парням", вам просто необходимо узнать о базовых принципах обеспечения 
безопасности PHP-приложений - конфигурировании веб-сервера в определённых случаях и собственно об обеспечении
безопасности веб-приложения. По этим темам мнения людей широко расходятся, так что, после того как вы 
определите основные проблемы обеспечения безопасности, вам необходимо будет выбрать наилушие решения, 
основываясь на мнениях разных людей. Я хочу дать вам наводку на очень хороший ресурс, фактически это книга,
находящаяся в процессе написания - 
[Survive The Deep End: PHP Security](http://phpsecurity.readthedocs.org/en/latest/), за авторством Pádraic Brady.

When it comes to all the extra security-related measures that are not bundled by default with Symfony, 
I would like to point you to my own website, where I have posted some articles about 
[security enhancements for your application](http://php-and-symfony.matthiasnoback.nl/category/security/).
Know your way around in the land of PHP, web application and Symfony security. Don’t trust “the framework” blindly. 
And when you have set up your security preventions: know if and why they work.

### 12.2 Goals: prevention and confinement

There are two ways in which you can enhance the security of your application: first you can try to prevent a bad 
thing from happening, second you can make arrangements so that when it happened anyway, things won’t get too far 
out of hand. The [OWASP Secure Coding Practices - Quick Reference Guide](https://www.owasp.org/index.php/OWASP_Secure_Coding_Practices_-_Quick_Reference_Guide) 
guide puts this as follows: 

    A threat agent interacts with a system, which may have a vulnerability that can be exploited in order to cause 
    an impact.
   
Your Symfony application is a system which almost certainly has vulnerabilities (unless it just displays 
“Hello world!”) and these can be used to break through the thresholds you have placed around your (sensitive) 
data. Though you should do everything you reasonably can to prevent this from happening, you need to think 
about what could happen in the case of a security breach. After all, this could be a matter of a leaked 
password, or even a brute-forced entry to the database server.

What does the “hacker” get, and how much time will it take him to get more? And exactly which data has been 
compromised? Should you inform users about the attack? Which users? Can you track this down? And in the case 
of a credentials database, could the hashed passwords be “unhashed” using brute-force tactics in a reasonable 
amount of time?

For example, when your application has a comment system which allows users to directly write a comment on a 
page, a malevolent user may try to add a JavaScript snippet to a comment. When you don’t have output escaping 
enabled for these comments, the snippet will just end up on the page as if it were application code. 
This would be a serious vulnerability of your application. A threat agent could inject a piece of 
JavaScript that examines document.cookie to find out the ID of the user’s session as it is stored in 
the session cookie. He may then even hijack the user’s session in his own browser.

#### Minimize impact

The JavaScript injection exploit will have quite a big impact, since taking over (any) user’s sessions 
is a very dangerous thing, even more so when the user is an administrator. To minimize the impact you 
should take several security measures. First of all you should configure PHP to mark the session cookie 
as HTTP-only. This makes it impossible to read from or write to the session cookie in JavaScript. Then 
you should find a way to detect hijacked sessions and reject them. There are many more options here, 
and they all reduce the chance of a security breach, but equally important: they also reduce the impact.

#### Reflection
It is clear that you should try to find and remove vulnerabilities and that you should also minimize 
the impact of a possible (even an improbable) attack. But what’s also important is that you know what 
you are trying to achieve by a certain security measure. It helps you with determining the right solution, 
when you know what the problem is that you are trying to solve. Be very reflective about your own ways. 
Sometimes it will occur to you that you are taking measures that won’t help at all, since you already 
have a stronger security measure in place. And sometimes you will notice that one very insecure part 
could indirectly give a threat agent access to another, secure part of the system.

#### Before diving in...

There is so much you can do when it comes to (web) application security - you probably won’t be able to 
implement it all. You also won’t need to. Talk with your team members about the necessary security 
measurements, and some quick wins. But also talk with your manager about the time budget and the importance 
of security for a specific project (or the organization). Security should be a team effort, and a secure 
application comes for the biggest part from awareness and discipline. So make sure that everybody on your 
team thinks alike when it comes to securing the application that you’re creating.

In the following chapters I will show you ways in which you can prevent bad things from
happening to your Symfony application, but also how you can apply some damage control here and there.